<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erthaware | Schedule a Pickup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400..800&family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <style>
        html, body {
            background-color: #F8F6F2;
            min-height: 100vh;
        }
        body {
            font-family: 'Space Grotesk', sans-serif;
            color: #2D3436;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 800 800' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        .font-display {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            text-transform: uppercase;
        }
        .action-btn {
            transition: all 0.2s ease;
            box-shadow: 3px 3px 0px 0px #2D3436;
            border: 2px solid #2D3436;
        }
        .action-btn:hover {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px 0px #2D3436;
        }
        .action-btn:active, .action-btn.active {
            transform: translate(3px, 3px);
            box-shadow: 0px 0px 0px 0px #2D3436;
        }
        .action-btn:disabled {
            background-color: #b0b0b0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            border-color: #909090;
        }
        .calendar-day.available:hover {
            background-color: #d8e4c7;
        }
        .calendar-day.selected {
            background-color: #A3B18A;
            color: #2D3436;
            font-weight: bold;
        }
        .time-slot.selected {
            background-color: #3A5A40;
            color: white;
            transform: translate(3px, 3px);
            box-shadow: 0px 0px 0px 0px #2D3436;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 max-w-4xl">
        <div class="text-center mb-8">
            <h1 class="font-display text-4xl sm:text-5xl text-[#D97706]">Schedule a Pickup</h1>
            <p class="mt-2 text-slate-600 tracking-wider max-w-md mx-auto">
                Select a date and time that works for you. We'll handle the rest.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Side: Calendar and Time -->
            <div class="space-y-6">
                <!-- Calendar -->
                <div>
                    <h2 class="font-display text-2xl text-[#3A5A40] mb-3">1. Select a Date</h2>
                    <div class="bg-white/70 p-4 rounded-lg border">
                        <div class="flex items-center justify-between mb-4">
                            <button id="prevMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <h3 id="monthYear" class="font-bold text-lg"></h3>
                            <button id="nextMonth" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center">
                            <div class="font-bold text-xs text-slate-500">S</div>
                            <div class="font-bold text-xs text-slate-500">M</div>
                            <div class="font-bold text-xs text-slate-500">T</div>
                            <div class="font-bold text-xs text-slate-500">W</div>
                            <div class="font-bold text-xs text-slate-500">T</div>
                            <div class="font-bold text-xs text-slate-500">F</div>
                            <div class="font-bold text-xs text-slate-500">S</div>
                        </div>
                    </div>
                </div>

                <!-- Time Slots -->
                <div id="timeSlotContainer" class="hidden">
                    <h2 class="font-display text-2xl text-[#3A5A40] mb-3">2. Select a Time</h2>
                    <div id="timeSlotGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <!-- Time slots will be injected here -->
                    </div>
                     <div id="timeSlotSpinner" class="hidden text-center p-4">
                        <svg class="animate-spin h-8 w-8 text-[#D97706] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-sm text-slate-500">Loading available times...</p>
                    </div>
                </div>
            </div>

            <!-- Right Side: Booking Form -->
            <div id="bookingFormContainer" class="hidden">
                <h2 class="font-display text-2xl text-[#3A5A40] mb-3">3. Your Details</h2>
                <form id="bookingForm" class="bg-white/70 p-4 rounded-lg border space-y-4">
                    <input type="hidden" id="selectedDate" name="date">
                    <input type="hidden" id="selectedTime" name="time">

                    <div>
                        <label for="name" class="block text-sm font-bold text-slate-700 mb-1">Full Name</label>
                        <input type="text" id="name" name="name" required class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#A3B18A] focus:border-[#A3B18A] outline-none transition">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-bold text-slate-700 mb-1">Email</label>
                        <input type="email" id="email" name="email" required class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#A3B18A] focus:border-[#A3B18A] outline-none transition">
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-bold text-slate-700 mb-1">Pickup Address</label>
                        <input type="text" id="address" name="address" required class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#A3B18A] focus:border-[#A3B18A] outline-none transition">
                    </div>
                     <div>
                        <label for="notes" class="block text-sm font-bold text-slate-700 mb-1">Notes (optional)</label>
                        <textarea id="notes" name="notes" rows="2" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#A3B18A] focus:border-[#A3B18A] outline-none transition" placeholder="e.g., items are in a bag on the porch"></textarea>
                    </div>
                    <button type="submit" id="submitBtn" class="action-btn w-full bg-[#D97706] text-white p-3 rounded-lg font-bold text-lg">
                        Confirm Pickup
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-[#F8F6F2] p-6 sm:p-8 rounded-lg border-2 border-slate-800 shadow-xl max-w-sm w-full text-center">
             <svg class="w-16 h-16 text-[#3A5A40] mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 class="font-display text-2xl sm:text-3xl text-slate-800 mb-2">Booked!</h2>
            <p id="confirmationMessage" class="text-slate-600 mb-6"></p>
            <button onclick="closeModal()" class="action-btn w-full bg-[#A3B18A] text-slate-900 p-2 rounded-lg font-bold">
                Done
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            // IMPORTANT: Change this URL to your deployed Render backend URL
            const API_BASE_URL = 'http://localhost:3000'; 
            
            // --- STATE ---
            let currentDate = new Date();
            let selectedDate = null;
            let selectedTime = null;

            // --- DOM ELEMENTS ---
            const monthYearEl = document.getElementById('monthYear');
            const calendarGridEl = document.getElementById('calendarGrid');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const timeSlotContainer = document.getElementById('timeSlotContainer');
            const timeSlotGrid = document.getElementById('timeSlotGrid');
            const timeSlotSpinner = document.getElementById('timeSlotSpinner');
            const bookingFormContainer = document.getElementById('bookingFormContainer');
            const bookingForm = document.getElementById('bookingForm');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationMessage = document.getElementById('confirmationMessage');

            // --- CALENDAR LOGIC ---
            function renderCalendar() {
                calendarGridEl.innerHTML = `
                    <div class="font-bold text-xs text-slate-500">S</div><div class="font-bold text-xs text-slate-500">M</div>
                    <div class="font-bold text-xs text-slate-500">T</div><div class="font-bold text-xs text-slate-500">W</div>
                    <div class="font-bold text-xs text-slate-500">T</div><div class="font-bold text-xs text-slate-500">F</div>
                    <div class="font-bold text-xs text-slate-500">S</div>`; // Redraw headers

                const month = currentDate.getMonth();
                const year = currentDate.getFullYear();
                
                monthYearEl.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
                
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0,0,0,0);

                // Add blank days for the start of the month
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGridEl.insertAdjacentHTML('beforeend', '<div></div>');
                }

                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(year, month, day);
                    let classes = 'calendar-day cursor-pointer rounded-full p-2 transition-colors';
                    
                    if (dayDate < today) {
                        classes += ' text-slate-400 cursor-not-allowed';
                    } else {
                         classes += ' available';
                    }
                    if (selectedDate && dayDate.toDateString() === selectedDate.toDateString()) {
                        classes += ' selected';
                    }
                    
                    const dayEl = `<div class="${classes}" data-date="${dayDate.toISOString()}">${day}</div>`;
                    calendarGridEl.insertAdjacentHTML('beforeend', dayEl);
                }
            }

            // --- EVENT LISTENERS ---
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });
            
            calendarGridEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('available')) {
                    const dateISO = e.target.dataset.date;
                    selectedDate = new Date(dateISO);

                    // Update UI
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                    e.target.classList.add('selected');
                    
                    fetchAndDisplayTimeSlots(selectedDate);
                }
            });

            timeSlotGrid.addEventListener('click', (e) => {
                const timeSlotEl = e.target.closest('.time-slot');
                if (timeSlotEl) {
                    selectedTime = timeSlotEl.dataset.time;

                    // Update UI
                    document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
                    timeSlotEl.classList.add('selected');

                    // Show form
                    bookingFormContainer.classList.remove('hidden');
                    document.getElementById('selectedDate').value = selectedDate.toISOString().split('T')[0];
                    document.getElementById('selectedTime').value = selectedTime;
                }
            });

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Booking...';

                const formData = new FormData(bookingForm);
                const bookingDetails = {
                    date: formData.get('date'),
                    time: formData.get('time'),
                    name: formData.get('name'),
                    email: formData.get('email'),
                    address: formData.get('address'),
                    notes: formData.get('notes'),
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/api/book`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookingDetails)
                    });
                    
                    const result = await response.json();

                    if (response.ok) {
                        const formattedDate = selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                        confirmationMessage.textContent = `Your pickup is confirmed for ${formattedDate} at ${selectedTime}. A confirmation email has been sent to ${bookingDetails.email}.`;
                        confirmationModal.classList.remove('hidden');
                    } else {
                        throw new Error(result.message || 'Booking failed');
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Confirm Pickup';
                }
            });


            // --- API CALLS & UI UPDATES ---
            async function fetchAndDisplayTimeSlots(date) {
                timeSlotContainer.classList.remove('hidden');
                bookingFormContainer.classList.add('hidden'); // Hide form when date changes
                timeSlotGrid.innerHTML = '';
                timeSlotSpinner.classList.remove('hidden');
                
                try {
                    const dateString = date.toISOString().split('T')[0]; // YYYY-MM-DD
                    const response = await fetch(`${API_BASE_URL}/api/availability?date=${dateString}`);
                    if (!response.ok) {
                        throw new Error('Could not fetch times.');
                    }
                    const { availableTimes } = await response.json();
                    
                    timeSlotSpinner.classList.add('hidden');

                    if (availableTimes.length > 0) {
                        availableTimes.forEach(time => {
                            const timeEl = `
                                <button type="button" class="time-slot action-btn bg-[#A3B18A] text-slate-900 p-3 rounded-lg font-bold" data-time="${time}">
                                    ${time}
                                </button>`;
                            timeSlotGrid.insertAdjacentHTML('beforeend', timeEl);
                        });
                    } else {
                        timeSlotGrid.innerHTML = '<p class="text-slate-500 col-span-full text-center">No available times for this date.</p>';
                    }
                } catch (error) {
                    timeSlotSpinner.classList.add('hidden');
                    timeSlotGrid.innerHTML = `<p class="text-red-500 col-span-full text-center">Error: ${error.message}</p>`;
                }
            }
            
            // --- MODAL ---
            window.closeModal = function() {
                confirmationModal.classList.add('hidden');
                // Reset state
                selectedDate = null;
                selectedTime = null;
                bookingForm.reset();
                bookingFormContainer.classList.add('hidden');
                timeSlotContainer.classList.add('hidden');
                renderCalendar();
            }

            // --- INITIALIZATION ---
            renderCalendar();
        });
    </script>
</body>
</html>
