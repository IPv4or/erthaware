<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erthaware | Book a Pickup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400..800&family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            color: #2D3436;
            background-color: #F8F6F2;
        }
        .font-display {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            text-transform: uppercase;
        }
        .action-btn {
            transition: all 0.2s ease;
            box-shadow: 3px 3px 0px 0px #2D3436;
            border: 2px solid #2D3436;
        }
        .action-btn:hover {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px 0px #2D3436;
        }
        .action-btn:active {
            transform: translate(3px, 3px);
            box-shadow: 0px 0px 0px 0px #2D3436;
        }
        .action-btn:disabled {
            background-color: #b0b0b0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            border-color: #909090;
        }
        .time-slot.selected {
            background-color: #4B5320;
            color: white;
            border-color: #2D3436;
        }
    </style>
</head>
<body class="antialiased">

    <main class="container mx-auto max-w-2xl p-4 sm:p-6">
        <div class="text-center mb-8">
            <h1 class="font-display text-4xl sm:text-5xl text-[#4B5320]">Schedule a Pickup</h1>
            <p class="text-slate-600 mt-2">Select a date and time for your free donation pickup.</p>
        </div>

        <div id="app-content">
            <!-- Step 1: Date Selection -->
            <div id="date-selection" class="bg-white/70 p-6 rounded-lg border mb-6">
                <h2 class="font-bold text-xl mb-4">1. Select a Date</h2>
                <input type="date" id="date-picker" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-[#A3B18A] focus:border-[#A3B18A] outline-none transition">
            </div>

            <!-- Step 2: Time Selection -->
            <div id="time-selection" class="bg-white/70 p-6 rounded-lg border mb-6 hidden">
                <h2 class="font-bold text-xl mb-4">2. Select an Available Time</h2>
                <div id="time-slots" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <p class="text-slate-500" id="time-slots-loader">Loading times...</p>
                </div>
            </div>

            <!-- Step 3: Your Information -->
            <div id="info-form-section" class="bg-white/70 p-6 rounded-lg border hidden">
                <h2 class="font-bold text-xl mb-4">3. Your Information</h2>
                <form id="booking-form" class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-bold text-slate-700 mb-1">Full Name</label>
                        <input type="text" id="name" name="name" required class="w-full p-2 border border-slate-300 rounded-md">
                    </div>
                     <div>
                        <label for="email" class="block text-sm font-bold text-slate-700 mb-1">Email</label>
                        <input type="email" id="email" name="email" required class="w-full p-2 border border-slate-300 rounded-md">
                    </div>
                     <div>
                        <label for="address" class="block text-sm font-bold text-slate-700 mb-1">Pickup Address</label>
                        <input type="text" id="address" name="address" required class="w-full p-2 border border-slate-300 rounded-md">
                    </div>
                     <div>
                        <label for="notes" class="block text-sm font-bold text-slate-700 mb-1">Optional Notes</label>
                        <textarea id="notes" name="notes" rows="3" class="w-full p-2 border border-slate-300 rounded-md"></textarea>
                    </div>
                    <button type="submit" id="submit-btn" class="action-btn w-full bg-[#D97706] text-white p-3 rounded-lg font-bold text-lg">
                        Confirm Booking
                    </button>
                </form>
            </div>
        </div>

        <!-- Confirmation Message -->
        <div id="confirmation-message" class="hidden text-center bg-green-100 border-2 border-green-600 text-green-800 p-8 rounded-lg">
            <h2 class="font-display text-3xl">Thank You!</h2>
            <p class="mt-2">Your pickup is confirmed. We've sent a confirmation email with the details of your appointment.</p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CONFIGURATION ---
            const API_BASE_URL = 'https://erthaware-booking-api.onrender.com';

            // --- DOM ELEMENTS ---
            const datePicker = document.getElementById('date-picker');
            const timeSelectionDiv = document.getElementById('time-selection');
            const timeSlotsDiv = document.getElementById('time-slots');
            const timeSlotsLoader = document.getElementById('time-slots-loader');
            const infoFormSection = document.getElementById('info-form-section');
            const bookingForm = document.getElementById('booking-form');
            const submitBtn = document.getElementById('submit-btn');
            const appContent = document.getElementById('app-content');
            const confirmationMessage = document.getElementById('confirmation-message');

            // --- STATE ---
            let selectedTimeSlot = null;
            
            // Set minimum date to today
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            datePicker.setAttribute('min', `${yyyy}-${mm}-${dd}`);

            // --- FUNCTIONS ---
            async function fetchAvailability(date) {
                timeSlotsDiv.innerHTML = '';
                timeSlotsLoader.textContent = 'Checking available slots...';
                timeSlotsLoader.style.display = 'block';

                try {
                    const response = await fetch(`${API_BASE_URL}/api/availability?date=${date}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    
                    timeSlotsLoader.style.display = 'none';
                    if (data.availableTimes.length > 0) {
                        data.availableTimes.forEach(time => {
                            const btn = document.createElement('button');
                            btn.textContent = time;
                            btn.classList.add('time-slot', 'p-3', 'border-2', 'rounded-md', 'text-center', 'cursor-pointer', 'transition-colors', 'font-semibold');
                            btn.onclick = () => selectTime(btn);
                            timeSlotsDiv.appendChild(btn);
                        });
                    } else {
                        timeSlotsDiv.innerHTML = '<p class="text-slate-500 col-span-full text-center">Sorry, no pickup times are available on this date.</p>';
                    }
                } catch (error) {
                    console.error('Failed to fetch availability:', error);
                    timeSlotsLoader.style.display = 'none';
                    timeSlotsDiv.innerHTML = '<p class="text-red-500 col-span-full text-center">Could not load times. Please try again later.</p>';
                }
            }

            function selectTime(button) {
                document.querySelectorAll('.time-slot').forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedTimeSlot = button.textContent;
                infoFormSection.classList.remove('hidden');
            }

            // --- EVENT LISTENERS ---
            datePicker.addEventListener('change', () => {
                const selectedDate = datePicker.value;
                if (selectedDate) {
                    timeSelectionDiv.classList.remove('hidden');
                    infoFormSection.classList.add('hidden'); // Hide form when date changes
                    selectedTimeSlot = null; // Reset selection
                    fetchAvailability(selectedDate);
                } else {
                    timeSelectionDiv.classList.add('hidden');
                    infoFormSection.classList.add('hidden');
                }
            });

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = 'Booking...';

                const formData = new FormData(bookingForm);
                const bookingData = {
                    date: datePicker.value,
                    time: selectedTimeSlot,
                    name: formData.get('name'),
                    email: formData.get('email'),
                    address: formData.get('address'),
                    notes: formData.get('notes')
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/api/book`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookingData)
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.message || 'An unknown error occurred.');
                    }
                    
                    appContent.classList.add('hidden');
                    confirmationMessage.classList.remove('hidden');

                } catch (error) {
                    alert(`Booking failed: ${error.message}`);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Confirm Booking';
                }
            });
        });
    </script>
</body>
</html>

